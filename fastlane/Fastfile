# ğŸŒŸ Tarot Cards Fastlane é…ç½®
# æ­¤æ–‡ä»¶ç”¨äºè‡ªåŠ¨åŒ–æ‰“åŒ…æµç¨‹

# è‡ªå®šä¹‰é…ç½®æ–‡æ¡£ï¼š
# https://github.com/fastlane/fastlane/tree/master/fastlane/docs
# å¯ç”¨æ“ä½œï¼šhttps://docs.fastlane.tools/actions/

# æ›´æ–° fastlane åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
# update_fastlane

# fastlane æœ€ä½ç‰ˆæœ¬è¦æ±‚
fastlane_version "2.59.0"

default_platform :ios

# å½’æ¡£å‡½æ•° - ç»Ÿä¸€å¤„ç†æ‰“åŒ…æµç¨‹
def archive(output_path, output_name, scheme, method, configuration)
  gym(
      output_directory: output_path,
      output_name: output_name,
      scheme: scheme,
      export_method: method, # å½’æ¡£ç±»å‹ï¼Œå¯é€‰ï¼šapp-store, ad-hoc, package, enterprise, development, developer-id
      configuration: configuration,
      clean: true,
      export_xcargs: "-allowProvisioningUpdates",
      # include_symbols: false,
      # include_bitcode: true,
      # use_legacy_build_api: false # ä½¿ç”¨æ–°ç‰ˆæœ¬ XCode API
  )
end

# ä¸Šä¼ åˆ° fir.im å‡½æ•°
def to_firim(ipaName)
  # ä» git commits ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼ˆæœ€è¿‘ 20 æ¡ï¼Œæ’é™¤åˆå¹¶æäº¤ï¼‰
  changelog_from_git_commits(commits_count: 20, pretty: '- %s', merge_commit_filtering: 'exclude_merges')
  # ä¸Šä¼ åˆ° fir.im
  sh("fir p ../build/#{ipaName}.ipa")
end

platform :ios do
  # è·å–å½“å‰æ—¶é—´ï¼Œç”¨äºå‘½åæ–‡ä»¶
  time = Time.new.strftime("%Y-%m-%d-%H-%M-%S")

  before_all do
    # åœ¨æ‰“åŒ…å‰æ‰§è¡Œçš„æ“ä½œ
    # ENV["SLACK_URL"] = "https://hooks.slack.com/services/..."
    # å®‰è£… CocoaPods
    changelog_from_git_commits(commits_count: 20, pretty: '- %s', merge_commit_filtering: 'exclude_merges')
    # å¯é€‰ï¼šæ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
    # sh("rm -rf ../build")
  end

  desc "Tarot Cards App Store æ‰“åŒ…"
  lane :appstore do
    scheme = 'tarot_cards'
    name = scheme + time
    archive('./build', name, scheme, 'app-store', 'Release')
    to_firim(name)
  end

  desc "Tarot Cards Ad-hoc æ‰“åŒ…"
  lane :adhoc do
    scheme = 'tarot_cards'
    name = scheme + time
    archive('./build', name, scheme, 'ad-hoc', 'Release')
    to_firim(name)
  end

  desc "Tarot Cards Development æ‰“åŒ…"
  lane :development do
    scheme = 'tarot_cards'
    name = scheme + time
    archive('./build', name, scheme, 'development', 'Debug')
    to_firim(name)
  end

  after_all do |lane|
    # æ‰“åŒ…æˆåŠŸåæ‰§è¡Œçš„æ“ä½œ
    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥ã€æˆªå›¾ä¸Šä¼ ç­‰
    puts "âœ… æ‰“åŒ…æˆåŠŸï¼"
  end

  error do |lane, exception|
    # æ‰“åŒ…å¤±è´¥åæ‰§è¡Œçš„æ“ä½œ
    # slack(
    #   message: exception.message,
    #   success: false
    # )
    puts "âŒ æ‰“åŒ…å¤±è´¥ï¼š#{exception.message}"
  end
end


# æ›´å¤šä¿¡æ¯ï¼š
# iOS å¹³å°æ–‡æ¡£ï¼šhttps://docs.fastlane.tools/ios
# æ‰€æœ‰å¯ç”¨æ“ä½œï¼šhttps://docs.fastlane.tools/actions/

# fastlane ä¼šè‡ªåŠ¨è®°å½•ä½¿ç”¨çš„æ“ä½œï¼Œä¸ä¼šæ”¶é›†ä¸ªäººæ•°æ®
# äº†è§£æ›´å¤šï¼šhttps://docs.fastlane.tools/#metrics
